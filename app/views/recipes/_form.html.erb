<%= form_with model: @recipe do |f| %>
  <% if recipe.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>

      <ul>
        <% recipe.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="flex ml-230 whitespace-nowrap">
    <div class="pt-2">
      <%= link_to "レシピ一覧へ", recipes_path, onclick: "if (confirm('内容を破棄して戻ります')) { window.location.href = '#{recipes_path}'; } return false;" %>
    </div>
      <%= link_to "リセット", new_recipe_path, class: "rounded-lg bg-red-500 text-white px-4 my-2 ml-6", onclick: "if (confirm('入力内容をリセットします')) { window.location.href = '#{new_recipe_path}'; } return false;" %>
      <%= f.submit "投稿", class: "rounded-lg bg-green-400 text-stone-700 px-4 my-2 ml-2" %>
  </div>

  <div class="flex">
    <div class="ml-10 text-[15px] py-2">
      <%= f.label :" ", style: "display: block;" %>
      <%= f.file_field :image,  id: 'image_input', style: "display: none;" %>
      <%= f.hidden_field :image_cache %>
      <label for="image_input" class="bg-gray-200 text-center cursor-pointer inline-block w-[500px] h-[25px] flex items-center justify-center">
        料理の写真をのせる
      </label>
      <img id="image_preview" src="<%= @recipe.image.url %>" alt="Image Preview" style="display: block; width: 500px; height: auto" />
    </div>
    <div class="text-[20px] py-2 ml-40">
      <%= f.label :" ", style: "display: block;" %>
      <%= f.text_field :title, style: "font-size: 24px; width: 500px; height: 60px; text-align: center;", placeholder: " 例）カレーライス", class: "mb-4 bg-gray-300" %>
      <%= f.label :" ", style: "display: block;" %>
      <%= f.text_field :tag_id, style: "font-size: 24px; width: 300px; height: 60px; text-align: center;", placeholder: "苦手な食材を選択", class: "mb-8 bg-gray-300" %>
      <div class="flex items-center text-right text-[20px] py-2">
        <%= f.label :"克服ポイント：", style: "margin-right: 10px;"%>
        <%= f.number_field :get_point, in: 1..3, step: 1, required: true, style: "width: 50px; height: 30px; text-align: center;" , class: "bg-gray-300" %>
      </div>
    </div>
  </div>
  <div class="text-[20px] ml-15 mb-5">
    【材料】
  </div>
  <div class="mt-5 ml-10">
    <div id="ingredients">
      <%= f.fields_for :ingredients do |ingredient_fields| %>
        <div class="ingredient">
          <%= ingredient_fields.hidden_field :_destroy %>
          <%= ingredient_fields.text_field :name, placeholder: " 例）にんじん", class: "bg-gray-300 mb-3 w-60" %>
          <%= ingredient_fields.text_field :quantity, placeholder: "例）1本", class: "bg-gray-300 mb-3 ml-4 w-18" %>
          <input type="button" value="削除" onclick="deleteRow(this)">
        </div>
      <% end %>
    </div>
    <button id="addButton" type="button">＋材料を追加</button>
  </div>
  <div class="ml-170">
    <p>【コツ・工夫点】</p>
    <%= f.label :" ", style: "display: block" %>
    <%= f.text_area :trick, style: "font-size: 14px; width: 500px; height: 60px; text-align: start; word-wrap: break-word;", placeholder: " 例）野菜がしんなりするまでよく炒める。歯応えが少なくなり食べやすくなります。", class: "h-48 bg-gray-300" %>
  </div>
<% end %>


<script>
    document.getElementById('image_input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = document.getElementById('image_preview');
            img.src = e.target.result; // 選択した画像のURLを設定
            img.style.display = 'block'; // 画像を表示
        }
        
        if (file) {
            reader.readAsDataURL(file); // 選択したファイルを読み込む
        }
    });
    document.getElementById('addButton').addEventListener('click', function() {
    const ingredientsDiv = document.getElementById('ingredients');
    const newIndex = ingredientsDiv.children.length; // 現在の行数を取得

    const newIngredientDiv = document.createElement('div');
    newIngredientDiv.className = 'ingredient';
  
    newIngredientDiv.innerHTML = `
      <input type="hidden" name="ingredient[_destroy]" value="0"> 
      <input type="text" name="recipe[ingredients_attributes][${newIndex}][name]" placeholder=" 例）にんじん" class="bg-gray-300 mb-3 w-60">
      <input type="text" name="recipe[ingredients_attributes][${newIndex}][quantity]" placeholder="例）1本" class="bg-gray-300 mb-3 ml-4 w-18">
      <input type="button" value="削除" onclick="deleteRow(this)">
    `;

    ingredientsDiv.appendChild(newIngredientDiv);
});
function deleteRow(button) {
  const ingredientDiv = button.parentElement;
  const hiddenField = ingredientDiv.querySelector('input[type="hidden"]');
  hiddenField.value = '1'; // _destroyを1に設定
  ingredientDiv.style.display = 'none'; // フォームを非表示にする
}
</script>